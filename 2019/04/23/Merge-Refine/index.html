<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="Contents Recap of Part 1 &amp; 2: Join Tables &amp; Stack the Headers The Code to Concatenate and Join the Data Recap of Part 1 &amp; 2: After scraping and wrangling all of the CMBS loan data from the SEC...">
        <meta name="keywords" content="python, tutorial">
        <link rel="icon" href="../../../../favicon.ico">

        <title>End-to-End Data Analysis Project: Part 3. Merge and Refine - Sonny's Blog</title>

        <!-- Stylesheets -->
        <link href="../../../../theme/css/bootstrap.min.css" rel="stylesheet">
        <link href="../../../../theme/css/fonts.css" rel="stylesheet">
        <link href="../../../../theme/css/nest.css" rel="stylesheet">
        <link href="../../../../theme/css/pygment.css" rel="stylesheet">
        <!-- /Stylesheets -->

        <!-- RSS Feeds -->
        <link href="https://sonnycruz.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Sonny's Blog Full Atom Feed" />
        <link href="https://sonnycruz.github.io/feeds/python.atom.xml" type="application/atom+xml" rel="alternate" title="Sonny's Blog Categories Atom Feed" />
        <!-- /RSS Feeds -->

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->



    </head>

    <body>

        <!-- Header -->
    <div class="header-container" style="background: linear-gradient(rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.2)), url('../../../../images/art-artistic-background-247676.jpg'); background-position: center; background-size: cover;">

            <!-- Static navbar -->
            <div class="container">
                <div class="header-nav">
                    <div class="header-logo">
                        <a class="pull-left" href="../../../../"><img class="mr20" src="../../../../images/blank.png" alt="logo">Sonny's Blog</a>
                    </div>
                    <div class="nav pull-right">
                            <a  href="../../../../pages/about-me.html">About Me</a>
                    </div>
                </div>
            </div>
            <!-- /Static navbar -->

            <!-- Header -->
    <!-- Header -->
    <div class="container header-wrapper">
        <div class="row">
              <div class="col-lg-12">
                  <div class="header-content">
                      <h1 class="header-title">End-to-End Data Analysis Project: Part 3. Merge and Refine</h1>
                      <p class="header-date"> <a href="../../../../author/sonny-torres.html">Sonny Torres</a>, Tue 23 April 2019,  <a href="../../../../category/python.html">Python</a></p>
                      <div class="header-underline"></div>
                      <div class="clearfix"></div>
                      <p class="pull-right header-tags">
                          <span class="glyphicon glyphicon-tags mr5" aria-hidden="true"></span>
<a href="../../../../tag/python.html">python</a>, <a href="../../../../tag/tutorial.html">tutorial</a>                      </p>
                  </div>
              </div>
        </div>
    </div>
    <!-- /Header -->
            <!-- /Header -->

        </div>
        <!-- /Header -->


        <!-- Content -->
    <div class="container content">
        <div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#recap-of-part-1-2" id="id1"><strong>Recap of Part 1 &amp; 2:</strong></a></li>
<li><a class="reference internal" href="#join-tables-stack-the-headers" id="id2"><strong>Join Tables &amp; Stack the Headers</strong></a></li>
<li><a class="reference internal" href="#the-code-to-concatenate-and-join-the-data" id="id3"><strong>The Code to Concatenate and Join the Data</strong></a></li>
</ul>
</div>
<div class="section" id="recap-of-part-1-2">
<h2><a class="toc-backref" href="#id1"><strong>Recap of Part 1 &amp; 2:</strong></a></h2>
<p>After scraping and wrangling all of the CMBS loan data from the SEC website (shown in my <a class="reference external" href="../../../../2018/12/23/Getting-Data/">first post</a>) and parsing the unwieldy header data, as covered in my <a class="reference external" href="../../../../2019/04/18/Parse-Headers/">previous post</a>, the next step in the data wrangling process is to join all of the table data (in the form of CSV files) into one CSV file and glue the parsed header data on top of the unified table. After joining all of the disparate data pieces and polishing the final data set, it will be ready for analysis in Part 4 of this Data Analysis Project series.</p>
</div>
<div class="section" id="join-tables-stack-the-headers">
<h2><a class="toc-backref" href="#id2"><strong>Join Tables &amp; Stack the Headers</strong></a></h2>
<p>Below is an illustration that describes the join operations I will explain in this post. The parsed header data is confined to a single row and is stacked on top of the various tables. The portions of the illustration highlighted in yellow show where the joins will occur among the various data pieces.</p>
<img alt="all tables join" src="/images/all_tables_join.jpg" style="width: 634.6px; height: 317.3px;" />
</div>
<div class="section" id="the-code-to-concatenate-and-join-the-data">
<h2><a class="toc-backref" href="#id3"><strong>The Code to Concatenate and Join the Data</strong></a></h2>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">unicodedata</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">main_dir</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;C:\Users\Username\Desktop\End-to-End-Data-Analysis\1. Get the Data\table&quot;</span>
<span class="n">parsed_header_file</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;C:\Users\storres.759NYY1\Desktop\End-to-End-Data-Analysis\1. Get the Data\header\frame.csv&quot;</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">main_dir</span><span class="p">)</span>

<span class="n">pattern</span> <span class="o">=</span> <span class="s1">&#39;*table.csv&#39;</span>

<span class="n">all_table_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span> <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">main_dir</span><span class="p">,</span> <span class="n">pattern</span><span class="p">))]</span>
<span class="n">number_of_files</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_table_files</span><span class="p">)</span>

<span class="n">df_top_half</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">df_bottom_half</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">blank_rows</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="c1"># selects first column, changes type to string,</span>
    <span class="c1"># initial type is object</span>
    <span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="s1">&#39;NFKD&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
    <span class="n">blank_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s+&#39;</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()]</span>
    <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
        <span class="n">index</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">tup</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">blank_match</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">number_of_files</span><span class="p">):</span>

    <span class="nb">file</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; table.csv&#39;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">,</span> <span class="n">na_values</span><span class="o">=</span><span class="s1">&#39;empty&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">blank_rows</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">df_top_half</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df_bottom_half</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">join_frames</span><span class="p">(</span><span class="n">list_of_frames</span><span class="p">):</span>
    <span class="c1"># horizontal join of dataframes</span>
    <span class="n">concat_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">obj</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">list_of_frames</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">concat_df</span>

<span class="k">def</span> <span class="nf">final_stack_df</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
    <span class="n">top_tables</span> <span class="o">=</span> <span class="n">join_frames</span><span class="p">(</span><span class="n">top</span><span class="p">)</span>
    <span class="n">bottom_tables</span> <span class="o">=</span> <span class="n">join_frames</span><span class="p">(</span><span class="n">bottom</span><span class="p">)</span>
    <span class="n">final</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">top_tables</span><span class="p">,</span> <span class="n">bottom_tables</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">)</span>
    <span class="n">final</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">columns</span>
    <span class="k">return</span> <span class="n">final</span>

<span class="n">cmbs</span> <span class="o">=</span> <span class="n">final_stack_df</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="n">df_top_half</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="n">df_bottom_half</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">parsed_header_file</span><span class="p">)</span>
<span class="n">cmbs</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;CMBS Final.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">)</span>

<span class="c1">##headers.columns = [re.sub(r&#39;_\d&#39;, &#39; &#39;, col) for col in headers.columns]</span>
<span class="c1">##headers.columns = [re.sub(r&#39;\s+&#39;, &#39; &#39;, col) for col in headers.columns]</span>
<span class="c1">##headers.columns = [val.strip() for val in headers.columns]</span>
<span class="c1">##other.columns = headers.columns</span>
<span class="c1">##other.to_csv(&#39;jpc11c05.csv&#39;, index=False, encoding=&#39;ISO-8859-1&#39;)</span>
</pre></div>
</div>



        
    </div>
        <!-- /Content --> 

        <!-- Footer -->
        <div class="footer gradient-2">
            <div class="container footer-container ">
                <div class="row">
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title"></div>
                        <ul class="list-unstyled">
                            <li><a href="https://sonnycruz.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"></a></li>
                        </ul>
                    </div>
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title"></div>
                        <ul class="list-unstyled">
                            <li><a href="" target="_blank"></a></li>
                            <li><a href="#" target="_blank"></a></li>
                        </ul>
                    </div>
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title"></div>
                        <ul class="list-unstyled">
                            <li><a href="linkedin.com/in/sonny-torres-6738b780" target="_blank">LinkedIn</a></li>
                            <li><a href="https://github.com/sonnycruz" target="_blank">Github</a></li>
                            <li><a href="https://twitter.com/sonnyctorres" target="_blank">Twitter</a></li>
                            <li><a href="#" target="_blank"></a></li>
                        </ul>
                    </div> 
                    <div class="col-xs-12 col-sm-3 col-md-3 col-lg-3">
                        <p class="pull-right text-right">
                            <small><em>Proudly powered by <a href="http://docs.getpelican.com/" target="_blank">pelican</a></em></small><br/>
                            <small><em>Theme and code by <a href="https://github.com/molivier" target="_blank">molivier</a></em></small><br/>
                            <small></small>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <!-- /Footer -->
    </body>
</html>